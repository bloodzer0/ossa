# SSRF漏洞

## 漏洞概述

​    SSRF(Server-Side Request Forgery: 服务器端请求伪造) 是一种由攻击者构造形成由服务
端发起请求的一个安全漏洞。一般情况下，SSRF 攻击的目标是从外网无法访问的内部系统。
（正是因为它是由服务端发起的，所以它能够请求到与它相连而与外网隔离的内部系统）。
SSRF 形成的原因大都是由于服务端提供了从其他服务器应用获取数据的功能且没有对目标
地址做过滤与限制。比如从指定 URL 地址获取网页文本内容，加载指定地址的图片，下载
等等。

## 漏洞原理

![ssrf-5](https://github.com/bloodzer0/Enterprise_Security_Build--Open_Source/blob/master/Application%20Security/Vulnerability/img/ssrf-5.png)


## 导致SSRF漏洞的敏感函数

- file_get_contents

![ssrf-2](https://github.com/bloodzer0/Enterprise_Security_Build--Open_Source/blob/master/Application%20Security/Vulnerability/img/ssrf-2.png)

- fsockopen

![ssrf-3](https://github.com/bloodzer0/Enterprise_Security_Build--Open_Source/blob/master/Application%20Security/Vulnerability/img/ssrf-3.png)

- curl_exec
![ssrf-4](https://github.com/bloodzer0/Enterprise_Security_Build--Open_Source/blob/master/Application%20Security/Vulnerability/img/ssrf-4.png)

## SSRF 漏洞挖掘

### 基于 WEB功能挖掘

(一) 分享功能：通过 URL 地址分享网页内容

(二) 通过转码服务：通过 URL 地址把原地址的网页内容调优使其适合手机屏幕浏览。

(三) 在线翻译服务：通过 URL 地址翻译对应文本的内容。

(四) 图片加载与下载：通过 URL 地址加载或者下载图片

(五) 图片、文章收藏功能等

(六) Webmail 收取其它邮箱邮件 (POP3/IMAP/SMTP)

(七) 数据库内置功能（Oracle、Mongodb、MSSQL、Postgres、CouchDB）

### 实际漏洞挖掘中的SSRF漏洞

![ssrf-1](https://github.com/bloodzer0/Enterprise_Security_Build--Open_Source/blob/master/Application%20Security/Vulnerability/img/ssrf-1.png)

### 基于 URL关键字挖掘

| 关键字      | 示例                                                      |
| ----------- | --------------------------------------------------------- |
| share       | 待补充                                                         |
| wap         | 待补充                                                          |
| url         | http://www.anquan.us/static/bugs/wooyun-2015-091695.html  |
| link        | http://www.anquan.us/static/bugs/wooyun-2015-091690.html  |
| src         | http://www.anquan.us/static/bugs/wooyun-2016-0167695.html |
| source      | http://www.anquan.us/static/bugs/wooyun-2015-0127770.html |
| target      | 待补充                                                     |
| u           | 待补充                                                    |
| 3g          | http://www.anquan.us/static/bugs/wooyun-2015-091770.html  |
| display     | 待补充                                                         |
| resourceURL | http://www.anquan.us/static/bugs/wooyun-2015-096928.html  |
| imageURL    | http://www.anquan.us/static/bugs/wooyun-2015-091768.html  |
| domain      | 待补充                                                        |

## 漏洞利用中支持的伪协议

- http
- file
- sftp
- dict
- gopher
- tftp
- ldap

## 漏洞修复与防御

1、过滤返回信息，验证远程服务器对请求的响应是比较容易的方法；
2、统一错误信息，避免用户可以根据错误信息来判断远端服务器的端口状态；
3、限制请求的端口为 http 常用的端口，比如，80,443,8080,8090；
4、黑名单内网 ip。避免应用被用来获取获取内网数据，攻击内网；
5、禁用不需要的协议。仅允许 http 和 https 请求；
6、使用正则对参数进行效验，防止畸形请求绕过黑名单。

## 相关参考

1. SSRF攻击实例解析

   https://www.freebuf.com/articles/web/20407.html

2. SSRF漏洞集合

   http://www.anquan.us/search?keywords=SSRF&&content_search_by=by_bugs&&search_by_html=False&&page=1

3. 《Build Your SSRF EXP Autowork》猪猪侠
